class t{constructor(){this.name="Lodash",this.version="1.2.0",console.log(`\n${this.name} v${this.version}\n`)}get(t={},e="",s=void 0){Array.isArray(e)||(e=this.toPath(e));const a=e.reduce(((t,e)=>Object(t)[e]),t);return void 0===a?s:a}set(t={},e="",s){return Array.isArray(e)||(e=this.toPath(e)),e.slice(0,-1).reduce(((t,s,a)=>Object(t[s])===t[s]?t[s]:t[s]=/^\d+$/.test(e[a+1])?[]:{}),t)[e[e.length-1]]=s,t}unset(t={},e=""){return Array.isArray(e)||(e=this.toPath(e)),e.reduce(((t,s,a)=>a===e.length-1?(delete t[s],!0):Object(t)[s]),t)}toPath(t){return t.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}escape(t){const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return t.replace(/[&<>"']/g,(t=>e[t]))}unescape(t){const e={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return t.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,(t=>e[t]))}}var e={Switch:!0,Type:"Translate",Types:["Official","Translate"],Languages:["EN","ZH"],CacheSize:50},s={breakLine:{"text/xml":"&#x000A;","application/xml":"&#x000A;","text/vtt":"\n","application/vtt":"\n","text/json":"\n","application/json":"\n"}},a={Settings:e,Configs:s},r=Database={Default:Object.freeze({__proto__:null,Configs:s,Settings:e,default:a})};const o=new class{constructor(e,s){this.name=e,this.version="1.5.9",this.data=null,this.dataFile="box.dat",this.logs=[],this.isMute=!1,this.logSeparator="\n",this.encoding="utf-8",this.startTime=(new Date).getTime(),Object.assign(this,s),this.log("","🚩 开始!",`ENV v${this.version}`,""),this.lodash=new t(this.name),this.log("",this.name,"")}platform(){return"undefined"!=typeof $environment&&$environment["surge-version"]?"Surge":"undefined"!=typeof $environment&&$environment["stash-version"]?"Stash":"undefined"!=typeof module&&module.exports?"Node.js":"undefined"!=typeof $task?"Quantumult X":"undefined"!=typeof $loon?"Loon":"undefined"!=typeof $rocket?"Shadowrocket":"undefined"!=typeof Egern?"Egern":void 0}isNode(){return"Node.js"===this.platform()}isQuanX(){return"Quantumult X"===this.platform()}isSurge(){return"Surge"===this.platform()}isLoon(){return"Loon"===this.platform()}isShadowrocket(){return"Shadowrocket"===this.platform()}isStash(){return"Stash"===this.platform()}isEgern(){return"Egern"===this.platform()}toObj(t,e=null){try{return JSON.parse(t)}catch{return e}}toStr(t,e=null){try{return JSON.stringify(t)}catch{return e}}getjson(t,e){let s=e;if(this.getdata(t))try{s=JSON.parse(this.getdata(t))}catch{}return s}setjson(t,e){try{return this.setdata(JSON.stringify(t),e)}catch{return!1}}getScript(t){return new Promise((e=>{this.get({url:t},((t,s,a)=>e(a)))}))}runScript(t,e){return new Promise((s=>{let a=this.getdata("@chavy_boxjs_userCfgs.httpapi");a=a?a.replace(/\n/g,"").trim():a;let r=this.getdata("@chavy_boxjs_userCfgs.httpapi_timeout");r=r?1*r:20,r=e&&e.timeout?e.timeout:r;const[o,i]=a.split("@"),n={url:`http://${i}/v1/scripting/evaluate`,body:{script_text:t,mock_type:"cron",timeout:r},headers:{"X-Key":o,Accept:"*/*"},timeout:r};this.post(n,((t,e,a)=>s(a)))})).catch((t=>this.logErr(t)))}loaddata(){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),a=!s&&this.fs.existsSync(e);if(!s&&!a)return{};{const a=s?t:e;try{return JSON.parse(this.fs.readFileSync(a))}catch(t){return{}}}}}writedata(){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(this.dataFile),e=this.path.resolve(process.cwd(),this.dataFile),s=this.fs.existsSync(t),a=!s&&this.fs.existsSync(e),r=JSON.stringify(this.data);s?this.fs.writeFileSync(t,r):a?this.fs.writeFileSync(e,r):this.fs.writeFileSync(t,r)}}getdata(t){let e=this.getval(t);if(/^@/.test(t)){const[,s,a]=/^@(.*?)\.(.*?)$/.exec(t),r=s?this.getval(s):"";if(r)try{const t=JSON.parse(r);e=t?this.lodash.get(t,a,""):e}catch(t){e=""}}return e}setdata(t,e){let s=!1;if(/^@/.test(e)){const[,a,r]=/^@(.*?)\.(.*?)$/.exec(e),o=this.getval(a),i=a?"null"===o?null:o||"{}":"{}";try{const e=JSON.parse(i);this.lodash.set(e,r,t),s=this.setval(JSON.stringify(e),a)}catch(e){const o={};this.lodash.set(o,r,t),s=this.setval(JSON.stringify(o),a)}}else s=this.setval(t,e);return s}getval(t){switch(this.platform()){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":return $persistentStore.read(t);case"Quantumult X":return $prefs.valueForKey(t);case"Node.js":return this.data=this.loaddata(),this.data[t];default:return this.data&&this.data[t]||null}}setval(t,e){switch(this.platform()){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":return $persistentStore.write(t,e);case"Quantumult X":return $prefs.setValueForKey(t,e);case"Node.js":return this.data=this.loaddata(),this.data[e]=t,this.writedata(),!0;default:return this.data&&this.data[e]||null}}initGotEnv(t){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,t&&(t.headers=t.headers?t.headers:{},void 0===t.headers.Cookie&&void 0===t.cookieJar&&(t.cookieJar=this.ckjar))}async fetch(t={}||"",e={}){switch(t.constructor){case Object:t={...t,...e};break;case String:t={url:t,...e}}t.method||(t.method="GET",(t.body??t.bodyBytes)&&(t.method="POST")),delete t.headers?.["Content-Length"],delete t.headers?.["content-length"];const s=t.method.toLocaleLowerCase();switch(this.platform()){case"Loon":case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:return delete t.id,t.policy&&(this.isLoon()&&(t.node=t.policy),this.isStash()&&this.lodash.set(t,"headers.X-Stash-Selected-Proxy",encodeURI(t.policy))),ArrayBuffer.isView(t.body)&&(t["binary-mode"]=!0),await new Promise(((e,a)=>{$httpClient[s](t,((s,r,o)=>{s?a(s):(r.ok=/^2\d\d$/.test(r.status),r.statusCode=r.status,o&&(r.body=o,1==t["binary-mode"]&&(r.bodyBytes=o)),e(r))}))}));case"Quantumult X":switch(delete t.charset,delete t.path,delete t.scheme,delete t.sessionIndex,delete t.statusCode,t.policy&&this.lodash.set(t,"opts.policy",t.policy),(t?.headers?.["Content-Type"]??t?.headers?.["content-type"])?.split(";")?.[0]){default:delete t.bodyBytes;break;case"application/protobuf":case"application/x-protobuf":case"application/vnd.google.protobuf":case"application/grpc":case"application/grpc+proto":case"application/octet-stream":delete t.body,ArrayBuffer.isView(t.bodyBytes)&&(t.bodyBytes=t.bodyBytes.buffer.slice(t.bodyBytes.byteOffset,t.bodyBytes.byteLength+t.bodyBytes.byteOffset));case void 0:}return await $task.fetch(t).then((t=>(t.ok=/^2\d\d$/.test(t.statusCode),t.status=t.statusCode,t)),(t=>Promise.reject(t.error)));case"Node.js":let e=require("iconv-lite");this.initGotEnv(t);const{url:a,...r}=t;return await this.got[s](a,r).on("redirect",((t,e)=>{try{if(t.headers["set-cookie"]){const s=t.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),e.cookieJar=this.ckjar}}catch(t){this.logErr(t)}})).then((t=>(t.statusCode=t.status,t.body=e.decode(t.rawBody,this.encoding),t.bodyBytes=t.rawBody,t)),(t=>Promise.reject(t.message)))}}time(t,e=null){const s=e?new Date(e):new Date;let a={"M+":s.getMonth()+1,"d+":s.getDate(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length)));for(let e in a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t}msg(t=name,e="",s="",a){const r=t=>{switch(typeof t){case void 0:return t;case"string":switch(this.platform()){case"Surge":case"Stash":case"Egern":default:return{url:t};case"Loon":case"Shadowrocket":return t;case"Quantumult X":return{"open-url":t};case"Node.js":return}case"object":switch(this.platform()){case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:return{url:t.url||t.openUrl||t["open-url"]};case"Loon":return{openUrl:t.openUrl||t.url||t["open-url"],mediaUrl:t.mediaUrl||t["media-url"]};case"Quantumult X":return{"open-url":t["open-url"]||t.url||t.openUrl,"media-url":t["media-url"]||t.mediaUrl,"update-pasteboard":t["update-pasteboard"]||t.updatePasteboard};case"Node.js":return}default:return}};if(!this.isMute)switch(this.platform()){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":default:$notification.post(t,e,s,r(a));break;case"Quantumult X":$notify(t,e,s,r(a));case"Node.js":}if(!this.isMuteLog){let a=["","==============📣系统通知📣=============="];a.push(t),e&&a.push(e),s&&a.push(s),console.log(a.join("\n")),this.logs=this.logs.concat(a)}}log(...t){t.length>0&&(this.logs=[...this.logs,...t]),console.log(t.join(this.logSeparator))}logErr(t){switch(this.platform()){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:this.log("",`❗️ ${this.name}, 错误!`,t);break;case"Node.js":this.log("",`❗️${this.name}, 错误!`,t.stack)}}wait(t){return new Promise((e=>setTimeout(e,t)))}done(t={}){const e=((new Date).getTime()-this.startTime)/1e3;switch(this.log("",`🚩 ${this.name}, 结束! 🕛 ${e} 秒`,""),t.headers?.["Content-Encoding"]&&(t.headers["Content-Encoding"]="identity"),t.headers?.["content-encoding"]&&(t.headers["content-encoding"]="identity"),delete t.headers?.["Content-Length"],delete t.headers?.["content-length"],this.platform()){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":default:$done(t);break;case"Quantumult X":delete t.charset,delete t.host,delete t.method,delete t.path,delete t.scheme,delete t.sessionIndex,delete t.statusCode,t.body instanceof ArrayBuffer?(t.bodyBytes=t.body,delete t.body):ArrayBuffer.isView(t.body)?(t.bodyBytes=t.body.buffer.slice(t.body.byteOffset,t.body.byteLength+t.body.byteOffset),delete t.body):t.body&&delete t.bodyBytes,$done(t);break;case"Node.js":process.exit(1)}}getENV(t,e,s){let a=this.getjson(t,s),r={};if("undefined"!=typeof $argument&&Boolean($argument)){let t=Object.fromEntries($argument.split("&").map((t=>t.split("=").map((t=>t.replace(/\"/g,""))))));for(let e in t)this.lodash.set(r,e,t[e])}const o={Settings:s?.Default?.Settings||{},Configs:s?.Default?.Configs||{},Caches:{}};Array.isArray(e)||(e=[e]);for(let t of e)o.Settings={...o.Settings,...s?.[t]?.Settings,...r,...a?.[t]?.Settings},o.Configs={...o.Configs,...s?.[t]?.Configs},a?.[t]?.Caches&&"string"==typeof a?.[t]?.Caches&&(a[t].Caches=JSON.parse(a?.[t]?.Caches)),o.Caches={...o.Caches,...a?.[t]?.Caches};return this.traverseObject(o.Settings,((t,e)=>("true"===e||"false"===e?e=JSON.parse(e):"string"==typeof e&&(e=e.includes(",")?e.split(",").map((t=>this.string2number(t))):this.string2number(e)),e))),o}traverseObject(t,e){for(var s in t){var a=t[s];t[s]="object"==typeof a&&null!==a?this.traverseObject(a,e):e(s,a)}return t}string2number(t){return t&&!isNaN(t)&&(t=parseInt(t,10)),t}}("🍿️ DualSubs: ➕ AddOn v1.0.1(2) Microsoft.Translate.beta"),i={url:"https://edge.microsoft.com/translate/auth",headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}};(async()=>{const{Settings:t,Caches:e,Configs:s}=function(t,e,s,a){t.log(`☑️ ${t.name}, Set Environment Variables`,"");let{Settings:r,Caches:o,Configs:i}=t.getENV(e,s,a);return Array.isArray(r?.Types)||(r.Types=r.Types?[r.Types]:[]),t.log(`✅ ${t.name}, Set Environment Variables`,"Settings: "+typeof r,`Settings内容: ${JSON.stringify(r)}`,""),("object"!=typeof o?.Playlists||Array.isArray(o?.Playlists))&&(o.Playlists={}),o.Playlists.Master=new Map(JSON.parse(o?.Playlists?.Master||"[]")),o.Playlists.Subtitle=new Map(JSON.parse(o?.Playlists?.Subtitle||"[]")),"object"!=typeof o?.Subtitles&&(o.Subtitles=new Map(JSON.parse(o?.Subtitles||"[]"))),{Settings:r,Caches:o,Configs:i}}(o,"DualSubs",["Translate","API"],r);switch(o.log(`⚠ ${o.name}`,`Settings.Switch: ${t?.Switch}`,""),t.Switch){case!0:default:const e=await o.fetch(i);t.Vendor="Microsoft",o.lodash.set(t,"Microsoft.Version","Azure"),o.lodash.set(t,"Microsoft.Mode","Token"),o.lodash.set(t,"Microsoft.Token",e?.body),o.log(`⚠ ${o.name}`,`Settings: ${JSON.stringify(t)}`,""),o.setdata(t.Vendor,"@DualSubs.Translate.Settings.Vendor"),o.setdata(t.Microsoft.Version,"@DualSubs.API.Settings.Microsoft.Version"),o.setdata(t.Microsoft.Mode,"@DualSubs.API.Settings.Microsoft.Mode"),o.setdata(t.Microsoft.Token,"@DualSubs.API.Settings.Microsoft.Token");case!1:}})().catch((t=>o.logErr(t))).finally((()=>o.done()));
