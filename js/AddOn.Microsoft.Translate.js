console.log("🍿️ DualSubs: ➕ AddOn Microsoft Translate Response"),console.log("2024/10/12 15:15:48");const e=function(){if("undefined"!=typeof $environment&&$environment["surge-version"])return"Surge";if("undefined"!=typeof $environment&&$environment["stash-version"])return"Stash";if("undefined"!=typeof module&&module.exports)return"Node.js";if("undefined"!=typeof $task)return"Quantumult X";if("undefined"!=typeof $loon)return"Loon";if("undefined"!=typeof $rocket)return"Shadowrocket";if("undefined"!=typeof Egern)return"Egern"}();class t{static name="Lodash";static version="1.2.2";static about(){return console.log(`\n🟧 ${this.name} v${this.version}\n`)}static get(e={},t="",s=void 0){Array.isArray(t)||(t=this.toPath(t));const a=t.reduce(((e,t)=>Object(e)[t]),e);return void 0===a?s:a}static set(e={},t="",s){return Array.isArray(t)||(t=this.toPath(t)),t.slice(0,-1).reduce(((e,s,a)=>Object(e[s])===e[s]?e[s]:e[s]=/^\d+$/.test(t[a+1])?[]:{}),e)[t[t.length-1]]=s,e}static unset(e={},t=""){return Array.isArray(t)||(t=this.toPath(t)),t.reduce(((e,s,a)=>a===t.length-1?(delete e[s],!0):Object(e)[s]),e)}static toPath(e){return e.replace(/\[(\d+)\]/g,".$1").split(".").filter(Boolean)}static escape(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return e.replace(/[&<>"']/g,(e=>t[e]))}static unescape(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return e.replace(/&amp;|&lt;|&gt;|&quot;|&#39;/g,(e=>t[e]))}}class s{static name="Storage";static version="1.1.0";static about(){return o("",`🟧 ${this.name} v${this.version}`,"")}static data=null;static dataFile="box.dat";static#e=/^@(?<key>[^.]+)(?:\.(?<path>.*))?$/;static getItem(s=new String,a=null){let o=a;if(!0===s.startsWith("@")){const{key:e,path:a}=s.match(this.#e)?.groups;s=e;let i=this.getItem(s,{});"object"!=typeof i&&(i={}),o=t.get(i,a);try{o=JSON.parse(o)}catch(e){}}else{switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":o=$persistentStore.read(s);break;case"Quantumult X":o=$prefs.valueForKey(s);break;case"Node.js":this.data=this.#t(this.dataFile),o=this.data?.[s];break;default:o=this.data?.[s]||null}try{o=JSON.parse(o)}catch(e){}}return o??a}static setItem(s=new String,a=new String){let o=!1;if("object"==typeof a)a=JSON.stringify(a);else a=String(a);if(!0===s.startsWith("@")){const{key:e,path:i}=s.match(this.#e)?.groups;s=e;let r=this.getItem(s,{});"object"!=typeof r&&(r={}),t.set(r,i,a),o=this.setItem(s,r)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":o=$persistentStore.write(a,s);break;case"Quantumult X":o=$prefs.setValueForKey(a,s);break;case"Node.js":this.data=this.#t(this.dataFile),this.data[s]=a,this.#s(this.dataFile),o=!0;break;default:o=this.data?.[s]||null}return o}static removeItem(s){let a=!1;if(!0===s.startsWith("@")){const{key:e,path:o}=s.match(this.#e)?.groups;s=e;let i=this.getItem(s);"object"!=typeof i&&(i={}),keyValue=t.unset(i,o),a=this.setItem(s,i)}else switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:a=!1;break;case"Quantumult X":a=$prefs.removeValueForKey(s)}return a}static clear(){let t=!1;switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Node.js":default:t=!1;break;case"Quantumult X":t=$prefs.removeAllValues()}return t}static#t(e){if(!this.isNode())return{};{this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),o=!a&&this.fs.existsSync(s);if(!a&&!o)return{};{const e=a?t:s;try{return JSON.parse(this.fs.readFileSync(e))}catch(e){return{}}}}}static#s(e=this.dataFile){if(this.isNode()){this.fs=this.fs?this.fs:require("fs"),this.path=this.path?this.path:require("path");const t=this.path.resolve(e),s=this.path.resolve(process.cwd(),e),a=this.fs.existsSync(t),o=!a&&this.fs.existsSync(s),i=JSON.stringify(this.data);a?this.fs.writeFileSync(t,i):o?this.fs.writeFileSync(s,i):this.fs.writeFileSync(t,i)}}}async function a(s={}||"",a={}){switch(s.constructor){case Object:s={...a,...s};break;case String:s={...a,url:s}}s.method||(s.method="GET",(s.body??s.bodyBytes)&&(s.method="POST")),delete s.headers?.Host,delete s.headers?.[":authority"],delete s.headers?.["Content-Length"],delete s.headers?.["content-length"];const o=s.method.toLocaleLowerCase();switch(e){case"Loon":case"Surge":case"Stash":case"Egern":case"Shadowrocket":default:if(s.timeout)switch(s.timeout=parseInt(s.timeout,10),e){case"Loon":case"Shadowrocket":case"Stash":case"Egern":default:s.timeout=s.timeout/1e3;case"Surge":}if(s.policy)switch(e){case"Loon":s.node=s.policy;break;case"Stash":t.set(s,"headers.X-Stash-Selected-Proxy",encodeURI(s.policy));break;case"Shadowrocket":t.set(s,"headers.X-Surge-Proxy",s.policy)}return"boolean"==typeof s.redirection&&(s["auto-redirect"]=s.redirection),s.bodyBytes&&!s.body&&(s.body=s.bodyBytes,delete s.bodyBytes),await new Promise(((e,t)=>{$httpClient[o](s,((a,o,i)=>{a?t(a):(o.ok=/^2\d\d$/.test(o.status),o.statusCode=o.status,i&&(o.body=i,1==s["binary-mode"]&&(o.bodyBytes=i)),e(o))}))}));case"Quantumult X":return s.policy&&t.set(s,"opts.policy",s.policy),"boolean"==typeof s["auto-redirect"]&&t.set(s,"opts.redirection",s["auto-redirect"]),s.body instanceof ArrayBuffer?(s.bodyBytes=s.body,delete s.body):ArrayBuffer.isView(s.body)?(s.bodyBytes=s.body.buffer.slice(s.body.byteOffset,s.body.byteLength+s.body.byteOffset),delete object.body):s.body&&delete s.bodyBytes,await $task.fetch(s).then((e=>(e.ok=/^2\d\d$/.test(e.statusCode),e.status=e.statusCode,e)),(e=>Promise.reject(e.error)));case"Node.js":let a=require("iconv-lite");!function(e){this.got=this.got?this.got:require("got"),this.cktough=this.cktough?this.cktough:require("tough-cookie"),this.ckjar=this.ckjar?this.ckjar:new this.cktough.CookieJar,e&&(e.headers=e.headers?e.headers:{},void 0===e.headers.Cookie&&void 0===e.cookieJar&&(e.cookieJar=this.ckjar))}(s);const{url:i,...r}=s;return await this.got[o](i,r).on("redirect",((e,t)=>{try{if(e.headers["set-cookie"]){const s=e.headers["set-cookie"].map(this.cktough.Cookie.parse).toString();s&&this.ckjar.setCookieSync(s,null),t.cookieJar=this.ckjar}}catch(e){this.logErr(e)}})).then((e=>(e.statusCode=e.status,e.body=a.decode(e.rawBody,"utf-8"),e.bodyBytes=e.rawBody,e)),(e=>Promise.reject(e.message)))}}const o=(...e)=>console.log(e.join("\n"));var i={Default:{Settings:{Switch:!0,Type:"Translate",Types:["Official","Translate"],Languages:["EN","ZH"],CacheSize:50},Configs:{breakLine:{"text/xml":"&#x000A;","application/xml":"&#x000A;","text/vtt":"\n","application/vtt":"\n","text/json":"\n","application/json":"\n"}}}};function r(e,a,i){o("☑️ Set Environment Variables","");let{Settings:r,Caches:n,Configs:c}=function(e,a,o){let i=s.getItem(e,o),r={};switch(typeof $argument){case"string":let e=Object.fromEntries($argument.split("&").map((e=>e.split("=").map((e=>e.replace(/\"/g,""))))));for(let s in e)t.set(r,s,e[s]);break;case"object":for(let e in $argument)t.set(r,e,$argument[e])}const n={Settings:o?.Default?.Settings||{},Configs:o?.Default?.Configs||{},Caches:{}};Array.isArray(a)||(a=[a]);for(let e of a)n.Settings={...n.Settings,...o?.[e]?.Settings,...r,...i?.[e]?.Settings},n.Configs={...n.Configs,...o?.[e]?.Configs},i?.[e]?.Caches&&"string"==typeof i?.[e]?.Caches&&(i[e].Caches=JSON.parse(i?.[e]?.Caches)),n.Caches={...n.Caches,...i?.[e]?.Caches};return function e(t,s){for(var a in t){var o=t[a];t[a]="object"==typeof o&&null!==o?e(o,s):s(a,o)}return t}(n.Settings,((e,t)=>("true"===t||"false"===t?t=JSON.parse(t):"string"==typeof t&&(t=t.includes(",")?t.split(",").map((e=>c(e))):c(t)),t))),n;function c(e){return e&&!isNaN(e)&&(e=parseInt(e,10)),e}}(e,a,i);return Array.isArray(r?.Types)||(r.Types=r.Types?[r.Types]:[]),o(`✅ Set Environment Variables, Settings: ${typeof r}, Settings内容: ${JSON.stringify(r)}`,""),("object"!=typeof n?.Playlists||Array.isArray(n?.Playlists))&&(n.Playlists={}),n.Playlists.Master=new Map(JSON.parse(n?.Playlists?.Master||"[]")),n.Playlists.Subtitle=new Map(JSON.parse(n?.Playlists?.Subtitle||"[]")),"object"!=typeof n?.Subtitles&&(n.Subtitles=new Map(JSON.parse(n?.Subtitles||"[]"))),{Settings:r,Caches:n,Configs:c}}const n={url:"https://edge.microsoft.com/translate/auth",headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2 Safari/605.1.15",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8"}};(async()=>{const{Settings:e,Caches:c,Configs:l}=r("DualSubs",["Translate","API"],i);switch(o(`⚠ Settings.Switch: ${e?.Switch}`,""),e.Switch){case!0:default:const i=await a(n);t.set(e,"Vendor","Microsoft"),t.set(e,"Microsoft.Version","Azure"),t.set(e,"Microsoft.Mode","Token"),t.set(e,"Microsoft.Token",i?.body),o(`⚠ Settings: ${JSON.stringify(e)}`,""),s.setItem("@DualSubs.Translate.Settings.Vendor",e.Vendor),s.setItem("@DualSubs.API.Settings.Microsoft.Version",e.Microsoft.Version),s.setItem("@DualSubs.API.Settings.Microsoft.Mode",e.Microsoft.Mode),s.setItem("@DualSubs.API.Settings.Microsoft.Token",e.Microsoft.Token);case!1:}})().catch((t=>function(t){switch(e){case"Surge":case"Loon":case"Stash":case"Egern":case"Shadowrocket":case"Quantumult X":default:o("","❗️执行错误!",t,"");break;case"Node.js":o("","❗️执行错误!",t.stack,"")}}(t))).finally((()=>function(s={}){switch(e){case"Surge":s.policy&&t.set(s,"headers.X-Surge-Policy",s.policy),o("",`🚩 执行结束! 🕛 ${(new Date).getTime()/1e3-$script.startTime} 秒`,""),$done(s);break;case"Loon":s.policy&&(s.node=s.policy),o("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Stash":s.policy&&t.set(s,"headers.X-Stash-Selected-Proxy",encodeURI(s.policy)),o("",`🚩 执行结束! 🕛 ${(new Date-$script.startTime)/1e3} 秒`,""),$done(s);break;case"Egern":case"Shadowrocket":default:o("","🚩 执行结束!",""),$done(s);break;case"Quantumult X":s.policy&&t.set(s,"opts.policy",s.policy),delete s["auto-redirect"],delete s["auto-cookie"],delete s["binary-mode"],delete s.charset,delete s.host,delete s.insecure,delete s.method,delete s.opt,delete s.path,delete s.policy,delete s["policy-descriptor"],delete s.scheme,delete s.sessionIndex,delete s.statusCode,delete s.timeout,s.body instanceof ArrayBuffer?(s.bodyBytes=s.body,delete s.body):ArrayBuffer.isView(s.body)?(s.bodyBytes=s.body.buffer.slice(s.body.byteOffset,s.body.byteLength+s.body.byteOffset),delete s.body):s.body&&delete s.bodyBytes,o("","🚩 执行结束!",""),$done(s);break;case"Node.js":o("","🚩 执行结束!",""),process.exit(1)}}()));
